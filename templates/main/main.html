{% extends "base.html" %}
{% load humanize %} 
{% block content %}
<div style="max-width: 1200px; margin: 40px auto; padding: 0 20px; font-family: sans-serif;">
    
    <!-- 2x2 ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        
        <!-- 1. ìµœê·¼ ì—¬í–‰ì§€ (ì™¼ìª½ ìœ„) -->
        <div style="background: #fff; border: 1px solid #ddd; border-radius: 12px; padding: 25px; box-shadow: 2px 2px 10px rgba(0,0,0,0.05);">
            <h2 style="margin: 0 0 20px 0; border-bottom: 2px solid #333; padding-bottom: 10px;">ìµœê·¼ ì—¬í–‰ì§€</h2>
            
            {% for trip in recent_trips %}
            <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 2px 2px 10px rgba(0,0,0,0.05);">
                
                <h3 style="margin: 0 0 10px 0; color: #007bff; font-size: 1.4rem;">
                    {{ trip.name }}
                </h3>
                
                <p style="margin: 5px 0;">ğŸ“… <strong>ì—¬í–‰ê¸°ê°„:</strong> {{ trip.start_date }} ~ {{ trip.end_date }}</p>
                <p style="margin: 5px 0;">ğŸ’° <strong>ì§€ì¶œì´ì•¡:</strong> {{ trip.total_spent|intcomma }}ì›</p>
                
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #eee;">
                    <a href="{% url 'trip_detail' trip.id %}" style="text-decoration: none; color: #555; font-size: 0.9rem;">
                        <strong>ìƒì„¸ë³´ê¸° â†’</strong> 
                        <span style="color: #888; margin-left: 10px;">
                            {{ trip.memo|default:"ë“±ë¡ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤."|truncatechars:40 }}
                        </span>
                    </a>
                </div>
            </div>
            {% empty %}
            <p>ë“±ë¡ëœ ì—¬í–‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endfor %}
        </div>
        
        <!-- 2. ì¸ê¸° ì—¬í–‰ì§€ (ì˜¤ë¥¸ìª½ ìœ„) -->
        <div style="background: #fff; border: 1px solid #ddd; border-radius: 12px; padding: 25px; box-shadow: 2px 2px 10px rgba(0,0,0,0.05); max-height: 600px; overflow-y: auto;">
            <h2 style="margin: 0 0 20px 0; border-bottom: 2px solid #333; padding-bottom: 10px;">
                âœˆï¸ ì—°ë ¹ëŒ€ë³„ ì¸ê¸° ì—¬í–‰ì§€
            </h2>
            
            {% for age_data in age_group_data %}
            <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                <h3 style="color: #007bff; font-size: 1rem; margin-bottom: 15px;">
                    {{ age_data.age_label }} TOP 3
                </h3>
                
                {% if age_data.destinations %}
                    <ol style="margin: 0; padding-left: 20px; list-style: none;">
                    {% for dest in age_data.destinations %}
                        <li style="margin-bottom: 12px; padding-left: 25px; position: relative; font-size: 0.9rem;">
                            <span style="position: absolute; left: 0; top: 0; background: #28a745; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.75rem;">
                                {{ forloop.counter }}
                            </span>
                            <div>
                                <strong style="color: #333;">{{ dest.country__name }} - {{ dest.city__name }}</strong>
                                <br>
                                <small style="color: #999;">ğŸ‘¥ {{ dest.visit_count }}ëª…</small>
                            </div>
                        </li>
                    {% endfor %}
                    </ol>
                {% else %}
                    <p style="margin: 0; color: #999; font-size: 0.85rem; text-align: center;">
                        ë°ì´í„° ì—†ìŒ
                    </p>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- 3. êµ­ê°€ë³„ ì§€ì¶œ TOP 3 (ì™¼ìª½ ì•„ë˜) -->
        <div style="background: #fff; border: 1px solid #ddd; border-radius: 12px; padding: 25px; box-shadow: 2px 2px 10px rgba(0,0,0,0.05);">
            <h2 style="margin: 0 0 20px 0; border-bottom: 2px solid #333; padding-bottom: 10px;">ğŸŒ êµ­ê°€ë³„ ì§€ì¶œ TOP 3</h2>
            <div style="background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                <canvas id="topExpenseChart"></canvas>
            </div>
        </div>

        <!-- 4. ì„œë¹„ìŠ¤ í†µê³„ (ì˜¤ë¥¸ìª½ ì•„ë˜) - í¬ê¸° ì¶•ì†Œ -->
        <div style="background: #f4f4f4; border-radius: 12px; padding: 20px; border: 1px solid #eee;">
            <h2 style="margin-top: 0; font-size: 1.1rem; color: #444;">ğŸ“Š ì„œë¹„ìŠ¤ í†µê³„</h2>
            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #ddd;">
            
            <div style="margin-bottom: 15px;">
                <small style="color: #777; font-size: 0.85rem;">ì´ ì‚¬ìš©ì</small>
                <div style="font-size: 1.3rem; font-weight: bold;">{{ total_users|intcomma }}ëª…</div>
            </div>

            <div style="margin-bottom: 15px;">
                <small style="color: #777; font-size: 0.85rem;">ë“±ë¡ëœ ì—¬í–‰</small>
                <div style="font-size: 1.3rem; font-weight: bold;">{{ total_trips|intcomma }}ê±´</div>
            </div>

            <div style="margin-bottom: 0;">
                <small style="color: #777; font-size: 0.85rem;">ëˆ„ì  ì§€ì¶œ ê¸ˆì•¡</small>
                <div style="font-size: 1.3rem; font-weight: bold; color: #d63031;">{{ total_spent_all|intcomma }}ì›</div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('topExpenseChart').getContext('2d');
        
        const labels = {{ labels|safe }};
        const data = {{ data|safe }};
        
        if (labels.length === 0) {
            ctx.font = "14px sans-serif";
            ctx.textAlign = "center";
            ctx.fillText("ì§€ì¶œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", 100, 75);
            return;
        }

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56'
                    ],
                    hoverOffset: 6
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 15,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let value = context.raw;
                                return ' ' + value.toLocaleString() + 'ì›';
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}